import "./common.pkl"

class IngressRoute extends common.K8sObject {
    hidden dnsPrefix: String?
    hidden svc_port: Int
    hidden svc_name: String
    apiVersion = "traefik.io/v1alpha1"
    kind = "IngressRoute"
    metadata = new {
        annotations {
            ["cert-manager.io/cluster-issuer"] = "cloudflare-issuer"
        }
        name = namespace + "-ingressroute"
    }
    spec = new {
        entryPoints = new Listing {"websecure"}
        routes = new Listing {
            new {
                match = "Host(`" + (dnsPrefix.ifNonNull((v) -> (v + ".")) ?? "") + "kgb.birtdata.com`) && PathPrefix(`/`)"
                kind = "Rule"
                services = new Listing {
                    new {
                        name = svc_name
                        port = svc_port
                    }
                }
            }
        }
        tls = new {
            secretName = metadata.namespace + "-tls"
        }
    }
}
