service:
  annotations:
    tailscale.com/expose: "true"
providers:
  kubernetesCRD:
    allowCrossNamespace: true

ingressRoute:
  dashboard:
    enabled: true
    entryPoints: ["websecure"]
    # Add custom middlewares : authentication and redirection
    middlewares:
    matchRule: Host(`traefik.kgb.birtdata.com`)

extraObjects:
  - apiVersion: traefik.io/v1alpha1
    kind: Middleware
    metadata:
       name: authentik
       namespace: authentik
    spec:
      forwardAuth:
        address: http://authentik.kgb.birtdata.com/outpost.goauthentik.io/auth/traefik
        trustForwardHeader: true
        authResponseHeaders:
          - X-authentik-username
          - X-authentik-groups
          - X-authentik-email
          - X-authentik-name
          - X-authentik-uid
          - X-authentik-jwt
          - X-authentik-meta-jwks
          - X-authentik-meta-outpost
          - X-authentik-meta-provider
          - X-authentik-meta-app
          - X-authentik-meta-version

ports:
  web:
    redirectTo:
      port: websecure
  websecure:
    tls:
      secretName: traefik-tls
  dns-tcp:
    port: 53
    protocol: TCP
    exposedPort: 53
    expose:
      default: true
  dns-udp:
    port: 53
    protocol: UDP
    exposedPort: 53
    expose:
      default: true
